---
title: "Data Cleaning"
output: html_notebook
---
Setting path
NOTE: In order to run the script smoothly we recommend to have saved the folder
containing all the data sets in a separate folder called "Data-OW"
```{r}
path = "../Data-OW/"
```

Importing libraries
```{r}
pacman::p_load(readxl, lubridate, dplyr)
```

___________________________________________________
# DimProduct dataset

Setting the working directory and importing the datasets
```{r}
head(product.df <- read.csv(paste0(path,"Hackathon_DimProduct_SAN_vShared.csv"), 
                       header = TRUE), 10)
str(product.df)
```

Cleaning ProductKey Column
```{r}
product.df$ProductKey <- gsub("key_", "", product.df$ProductKey)
length(product.df$ProductKey)

# OK
```

Cleaning Product Sub-Category column. Indeed, lv2. has some categories that needs to  
be transformed from lower case to upper case before the substitution
```{r}
product.df$ProductCategory_Lvl1 <- gsub("Category ", "", 
                                        product.df$ProductCategory_Lvl1)

product.df$ProductCategory_Lvl2 <- toupper(product.df$ProductCategory_Lvl2)
product.df$ProductCategory_Lvl2 <- gsub("CATEGORY ", "", 
                                        product.df$ProductCategory_Lvl2)
```

Transforming categories into factors
```{r}
product.df$ProductCategory_Lvl1 <- as.factor(product.df$ProductCategory_Lvl1)
product.df$ProductCategory_Lvl2 <- as.factor(product.df$ProductCategory_Lvl2)
```

____________________
Quick exploration of categories
```{r}
table(product.df$ProductCategory_Lvl1) # Only Category A
```

At lv.1 only A category is present in the dataset

```{r}
table(product.df$ProductCategory_Lvl2)
```

"CATEGRORY AE" needs to be corrected, maybe we can later implement a way to 
correct the column no matter the spelling mistakes of "category" --> REGEX !! 

```{r}
product.df$ProductCategory_Lvl2[product.df$ProductCategory_Lvl2 == 
                                  "CATEGRORY AE"] <- "AE"
product.df$ProductCategory_Lvl2 <- droplevels(product.df$ProductCategory_Lvl2)
```

```{r}
table(product.df$ProductCategory_Lvl2)
```

Product suppliers
```{r}
length(unique(product.df$SupplierKey))
```
There are 17 Product suppliers

________________________________________________________
# CPI dataset

```{r}
setwd(path)
cpi.df <- read_xlsx("Consumer Price Index_vShared.xlsx")
```

```{r}
str(cpi.df)
```

Date columns are already in POSIXct format, no need for change

```{r}
summary(cpi.df)
```
Most of monthly data are missing, the information must be reconstructed starting from the daily data

Idea: creating the correspondence between month and year, and computing the monthly CPI as the mean of the daily CPI

```{r}
# Creating Date_Monthly and CPI_monthly columns
cpi.df1 <- cpi.df %>% 
  group_by(month(Date_daily), year(Date_daily)) %>% 
  mutate(Date_monthly1 = paste0(year(Date_daily),"-",month(Date_daily),"-01"),
         CPI_monthly1 = mean(CPI_daily))

cpi.df1 <- cpi.df1 %>% 
  ungroup() %>% 
  select(Date_monthly1, CPI_monthly1, Date_daily, CPI_daily)

# Creating the date format for Date_monthly1
cpi.df1$Date_monthly1 <- as.POSIXct(cpi.df1$Date_monthly1)

# Correcting columns name
colnames(cpi.df1) <- c("Date_monthly",
                       "CPI_monthly",
                       "Date_daily",
                       "CPI_daily")
```

Clearing the environment and final check
```{r}
cpi.df <- cpi.df1
remove(cpi.df1)
# Final check
str(cpi.df)

#OK
```

IMPORTANT NOTE:
There is a slight difference in monthly CPI computed as the mean of daily values and the one provided by the data.. Am I correcting the data or the monthly CPI is computed in a different way?

Maybe every month is standardized over 30 days
-> sum(CPI_daily)/30

___________________________________________________
# Promotion dataset

```{r}
setwd(path)
promotion.df <- read.table("Hackathon_DimPromotion_SAN_vShared.csv", 
                           header = TRUE,
                           sep = ",")
```

```{r}
str(promotion.df)
```

Transforming PromotionKey into character (might transform into factor later)
```{r}
promotion.df$PromotionKey <- as.character(promotion.df$PromotionKey)
```

Transforming Promotion Dates into POSIXct formats
```{r}
promotion.df$PromotionStartDate <- as.POSIXct(promotion.df$PromotionStartDate,
                                              format = "%m/%d/%Y")

promotion.df$PromotionEndDate <- as.POSIXct(promotion.df$PromotionEndDate,
                                            format = "%m/%d/%Y")
```

Transforming promotion mechanics into factor
```{r}
promotion.df$PromoMechanic <- as.factor(promotion.df$PromoMechanic)

table(promotion.df$PromoMechanic)
```
There are 15 promotion types + 1 unknown

```{r}
summary(promotion.df)
```
No missing values

OK

____________________________________________-
# Store Dataset

```{r}
setwd(path)
store.df <- read.table("Hackathon_DimStore_SAN_vShared.csv", 
                           header = TRUE,
                           sep = ",")
```

```{r}
str(store.df)
```

Transforming StoreKey  and DistributionChannel into factors
```{r}
store.df$StoreKey <- as.factor(store.df$StoreKey)
store.df$DistributionChannel <- as.factor(store.df$DistributionChannel)
```


Adjusting StoreType and transforming it into factor
```{r}
store.df$StoreType <- gsub("Store Type ", "", store.df$StoreType)
store.df$StoreType <- as.factor(store.df$StoreType)
```

Adjusting Region_lvl 1 and 2 and transforming into factors
```{r}
store.df$Region_Lvl1 <- gsub("Region", "", store.df$Region_Lvl1)
store.df$Region_Lvl2 <- gsub("Region ", "", store.df$Region_Lvl2)

store.df$Region_Lvl1 <- as.factor(store.df$Region_Lvl1)
store.df$Region_Lvl2 <- as.factor(store.df$Region_Lvl2)
```

Final check
```{r}
table(store.df$Region_Lvl1)
table(store.df$Region_Lvl2)
```

OK

_____________________________________
# Trasaction Dataset

```{r}
setwd(path)
transaction.df <- read.table("Hackathon_FactSalesTransactionDATES_vShared.csv", 
                             header = TRUE,
                             sep = ",")
```

```{r}
str(transaction.df)
```
Trasforming TransactionDate into POSIXct format (it takes a long time)
```{r}
transaction.df$TransactionDate <- as.POSIXct(transaction.df$TransactionDate, 
                                             format = "%Y-%m-%d")
```

Transforming DayOfWeek, WeekendFlag, StoreKey and ProductKey into factors
```{r}
transaction.df$DayOfWeek <- as.factor(transaction.df$DayOfWeek)
transaction.df$WeekendFlag <- as.factor(transaction.df$WeekendFlag)
transaction.df$StoreKey <- as.factor(transaction.df$StoreKey)
transaction.df$ProductKey <- as.factor(transaction.df$ProductKey)
```

```{r}
summary(transaction.df)
```
23978 missing transactions


_____________________________________
# Trasaction Promotion Dataset

```{r}
setwd(path)
transaction.promotion.df <- read.table("Hackathon_FactSalesTransactionPromotion_vShared.csv", 
                                       header = TRUE,
                                       sep = ",")
```

Transforming TransactionDate into POSIXct format
```{r}
transaction.promotion.df$TransactionDate <- as.POSIXct(transaction.promotion.df$TransactionDate,
                                                       format = "%Y-%m-%d")
```

Transforming StoreKey, ProductKey and Promotion Key into factors
```{r}
transaction.promotion.df$StoreKey <- as.factor(transaction.promotion.df$StoreKey)
transaction.promotion.df$ProductKey <- as.factor(transaction.promotion.df$ProductKey)
transaction.promotion.df$PromotionKey <- as.factor(transaction.promotion.df$PromotionKey)
```

```{r}
summary(transaction.promotion.df)
```

OK

_____________________________________
# Holiday

```{r}
setwd(path)
holiday.df <- read.table("Hackathon_HolidaysMY_vShared.csv", 
                                       header = TRUE,
                                       sep = ",")
```

Some information about holidays, we should search each period and merge the information